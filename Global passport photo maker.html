<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Global Passport Photo Maker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #334155;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            color: white;
        }
        
        h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .workflow {
            display: flex;
            justify-content: space-between;
            padding: 30px;
            background: #f8fafc;
            position: relative;
        }
        
        .workflow::before {
            content: '';
            position: absolute;
            top: 35px;
            left: 80px;
            right: 80px;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
            z-index: 1;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        
        .step-number {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 700;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-number {
            background: #10b981;
            color: white;
        }
        
        .step-title {
            font-weight: 600;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .step.active .step-title {
            color: #3b82f6;
        }
        
        .step.completed .step-title {
            color: #10b981;
        }
        
        .content-area {
            padding: 40px;
            min-height: 500px;
        }
        
        .step-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Upload Section */
        .upload-section {
            text-align: center;
        }
        
        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 15px;
            padding: 60px;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #8b5cf6;
            background: #f3f0ff;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #3b82f6;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .upload-subtext {
            color: #64748b;
        }
        
        #fileInput {
            display: none;
        }
        
        .uploaded-preview {
            margin-top: 30px;
            display: none;
        }
        
        .uploaded-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Country Selection */
        .country-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .country-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .country-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
        }
        
        .country-card.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #f0f9ff);
        }
        
        .country-flag {
            font-size: 3rem;
        }
        
        .country-info h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .country-specs {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .requirements-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }
        
        .requirements-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .req-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1e293b;
        }
        
        .req-list {
            list-style: none;
        }
        
        .req-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .req-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .req-icon {
            color: #10b981;
            margin-top: 2px;
        }
        
        /* Editor Section */
        .editor-container {
            display: flex;
            gap: 40px;
            margin-top: 30px;
        }
        
        .editor-preview {
            flex: 1;
            text-align: center;
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        #editCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .crop-overlay {
            position: absolute;
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
            display: none;
        }
        
        .crop-handles {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
        }
        
        .crop-handles.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .crop-handles.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .crop-handles.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .crop-handles.se { bottom: -6px; right: -6px; cursor: se-resize; }
        
        .head-guide {
            position: absolute;
            border: 2px dashed #ef4444;
            background: rgba(239, 68, 68, 0.05);
            pointer-events: none;
        }
        
        .editor-controls {
            width: 320px;
        }
        
        .control-group {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-label {
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-label i {
            color: #3b82f6;
        }
        
        .slider-container {
            margin-bottom: 15px;
        }
        
        .slider-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Background Section */
        .bg-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .bg-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bg-option:hover {
            border-color: #3b82f6;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
        }
        
        .bg-option.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #f0f9ff);
        }
        
        .bg-icon {
            font-size: 2.5rem;
            color: #3b82f6;
            margin-bottom: 15px;
        }
        
        .bg-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .bg-desc {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .color-palette {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
            justify-content: center;
        }
        
        .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .color-swatch.selected {
            border-color: #3b82f6;
            transform: scale(1.15);
        }
        
        /* Download Section */
        .download-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .download-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .download-option:hover {
            border-color: #3b82f6;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
        }
        
        .download-option.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #f0f9ff);
        }
        
        .download-icon {
            font-size: 2.5rem;
            color: #3b82f6;
            margin-bottom: 15px;
        }
        
        .download-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .download-desc {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .custom-layout {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }
        
        .custom-layout.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        .layout-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .layout-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .layout-input label {
            font-weight: 500;
        }
        
        .layout-input input {
            width: 80px;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
        }
        
        .preview-canvas {
            margin-top: 30px;
            text-align: center;
        }
        
        #previewCanvas {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            max-width: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #334155;
        }
        
        .btn-secondary:hover {
            background: #cbd5e1;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        /* Processing overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .processing-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .processing-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .processing-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: #334155;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
        }
        
        .notification.error {
            border-left: 4px solid #ef4444;
        }
        
        .notification-icon {
            font-size: 1.5rem;
        }
        
        .notification.success .notification-icon {
            color: #10b981;
        }
        
        .notification.error .notification-icon {
            color: #ef4444;
        }
        
        .notification-text {
            font-weight: 500;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .workflow {
                flex-direction: column;
                gap: 20px;
            }
            
            .workflow::before {
                display: none;
            }
            
            .editor-container {
                flex-direction: column;
            }
            
            .editor-controls {
                width: 100%;
            }
            
            .country-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Advanced Global Passport Photo Maker</h1>
            <p class="subtitle">Create professional passport photos that meet official requirements for any country worldwide</p>
        </header>
        
        <div class="main-card">
            <div class="workflow">
                <div class="step active" id="step1-indicator">
                    <div class="step-number">1</div>
                    <div class="step-title">Upload Photo</div>
                </div>
                <div class="step" id="step2-indicator">
                    <div class="step-number">2</div>
                    <div class="step-title">Select Country</div>
                </div>
                <div class="step" id="step3-indicator">
                    <div class="step-number">3</div>
                    <div class="step-title">Edit Photo</div>
                </div>
                <div class="step" id="step4-indicator">
                    <div class="step-number">4</div>
                    <div class="step-title">Background</div>
                </div>
                <div class="step" id="step5-indicator">
                    <div class="step-number">5</div>
                    <div class="step-title">Download</div>
                </div>
            </div>
            
            <div class="content-area">
                <!-- Step 1: Upload -->
                <div class="step-content active" id="step1">
                    <div class="upload-section">
                        <h2>Upload Your Photo</h2>
                        <p>Please upload a clear, recent photo of yourself facing the camera</p>
                        
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <div class="upload-text">Drag & Drop Your Photo Here</div>
                            <div class="upload-subtext">or click to browse (JPG, PNG, WebP - Max 10MB)</div>
                        </div>
                        <input type="file" id="fileInput" accept="image/*">
                        
                        <div class="uploaded-preview" id="uploadedPreview">
                            <img id="uploadedImage" class="uploaded-image" alt="Uploaded">
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-primary" id="nextStep1" disabled>
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Select Country -->
                <div class="step-content" id="step2">
                    <h2>Select Country</h2>
                    <p>Choose the country for your passport photo. We'll automatically apply the correct requirements</p>
                    
                    <div class="country-grid" id="countryGrid">
                        <!-- Countries will be populated by JavaScript -->
                    </div>
                    
                    <div class="requirements-panel" id="requirementsPanel">
                        <h3 class="req-title">Passport Photo Requirements</h3>
                        <ul class="req-list" id="requirementsList">
                            <!-- Requirements will be populated by JavaScript -->
                        </ul>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="prevStep2">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button class="btn btn-primary" id="nextStep2" disabled>
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Edit Photo -->
                <div class="step-content" id="step3">
                    <h2>Edit Your Photo</h2>
                    <p>Crop and adjust your photo to meet the selected country's requirements</p>
                    
                    <div class="editor-container">
                        <div class="editor-preview">
                            <div class="canvas-container">
                                <canvas id="editCanvas"></canvas>
                                <div class="crop-overlay" id="cropOverlay">
                                    <div class="crop-handles nw"></div>
                                    <div class="crop-handles ne"></div>
                                    <div class="crop-handles sw"></div>
                                    <div class="crop-handles se"></div>
                                </div>
                                <div class="head-guide" id="headGuide"></div>
                            </div>
                            <button class="btn btn-secondary" id="cropBtn">
                                <i class="fas fa-crop"></i> Enable Crop
                            </button>
                        </div>
                        
                        <div class="editor-controls">
                            <div class="control-group">
                                <div class="control-label">
                                    <i class="fas fa-sun"></i> Brightness
                                </div>
                                <div class="slider-container">
                                    <div class="slider-info">
                                        <span>Dark</span>
                                        <span id="brightnessValue">0</span>
                                        <span>Bright</span>
                                    </div>
                                    <input type="range" class="slider" id="brightnessSlider" min="-100" max="100" value="0">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <div class="control-label">
                                    <i class="fas fa-adjust"></i> Contrast
                                </div>
                                <div class="slider-container">
                                    <div class="slider-info">
                                        <span>Low</span>
                                        <span id="contrastValue">0</span>
                                        <span>High</span>
                                    </div>
                                    <input type="range" class="slider" id="contrastSlider" min="-100" max="100" value="0">
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <div class="control-label">
                                    <i class="fas fa-palette"></i> Saturation
                                </div>
                                <div class="slider-container">
                                    <div class="slider-info">
                                        <span>Low</span>
                                        <span id="saturationValue">0</span>
                                        <span>High</span>
                                    </div>
                                    <input type="range" class="slider" id="saturationSlider" min="-100" max="100" value="0">
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" id="resetFilters" style="width: 100%;">
                                <i class="fas fa-undo"></i> Reset All
                            </button>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="prevStep3">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button class="btn btn-primary" id="nextStep3">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 4: Background -->
                <div class="step-content" id="step4">
                    <h2>Background Options</h2>
                    <p>Choose the background that matches your country's requirements</p>
                    
                    <div class="bg-options">
                        <div class="bg-option selected" data-bg="original">
                            <i class="fas fa-image bg-icon"></i>
                            <div class="bg-title">Keep Original</div>
                            <div class="bg-desc">Use the original background</div>
                        </div>
                        <div class="bg-option" data-bg="remove">
                            <i class="fas fa-eraser bg-icon"></i>
                            <div class="bg-title">Remove Background</div>
                            <div class="bg-desc">Make background transparent</div>
                        </div>
                        <div class="bg-option" data-bg="color">
                            <i class="fas fa-fill-drip bg-icon"></i>
                            <div class="bg-title">Solid Color</div>
                            <div class="bg-desc">Choose a background color</div>
                        </div>
                    </div>
                    
                    <div class="color-palette" id="colorPalette" style="display: none;">
                        <!-- Colors will be populated by JavaScript -->
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="prevStep4">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button class="btn btn-primary" id="nextStep4">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 5: Download -->
                <div class="step-content" id="step5">
                    <h2>Download Your Photo</h2>
                    <p>Choose how you want to download your passport photo</p>
                    
                    <div class="download-options">
                        <div class="download-option selected" data-download="single">
                            <i class="fas fa-portrait download-icon"></i>
                            <div class="download-title">Single Photo</div>
                            <div class="download-desc">High-quality PNG file</div>
                        </div>
                        <div class="download-option" data-download="a4">
                            <i class="fas fa-file download-icon"></i>
                            <div class="download-title">A4 Sheet</div>
                            <div class="download-desc">8 photos per sheet</div>
                        </div>
                        <div class="download-option" data-download="halfa4">
                            <i class="fas fa-file-alt download-icon"></i>
                            <div class="download-title">Half A4</div>
                            <div class="download-desc">4 photos per sheet</div>
                        </div>
                        <div class="download-option" data-download="custom">
                            <i class="fas fa-th download-icon"></i>
                            <div class="download-title">Custom Layout</div>
                            <div class="download-desc">Create your own layout</div>
                        </div>
                    </div>
                    
                    <div class="custom-layout" id="customLayout">
                        <h3>Custom Sheet Layout</h3>
                        <div class="layout-controls">
                            <div class="layout-input">
                                <label>Rows:</label>
                                <input type="number" id="layoutRows" min="1" max="10" value="2">
                            </div>
                            <div class="layout-input">
                                <label>Columns:</label>
                                <input type="number" id="layoutCols" min="1" max="10" value="2">
                            </div>
                            <button class="btn btn-secondary" id="updateLayout">
                                <i class="fas fa-sync"></i> Update
                            </button>
                        </div>
                    </div>
                    
                    <div class="preview-canvas">
                        <canvas id="previewCanvas"></canvas>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="prevStep5">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button class="btn btn-primary" id="downloadBtn">
                            <i class="fas fa-download"></i> Download Photo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <div class="processing-text">Processing your photo...</div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle notification-icon"></i>
        <span class="notification-text">Success!</span>
    </div>
    
    <script>
        // Comprehensive country requirements database
        const countryData = {
            'US': {
                name: 'United States',
                flag: '🇺🇸',
                size: '2x2 inches (51x51 mm)',
                dimensions: { width: 51, height: 51, unit: 'mm' },
                background: ['White', 'Off-white'],
                headSize: '1 to 1 3/8 inches (25-35 mm)',
                requirements: [
                    'Photo taken within last 6 months',
                    'Neutral facial expression with both eyes open',
                    'Plain white or off-white background',
                    'Head must measure between 1 inch and 1 3/8 inches',
                    'No hats or head coverings (except for religious purposes)',
                    'No glasses with tinted lenses'
                ]
            },
            'IN': {
                name: 'India',
                flag: '🇮🇳',
                size: '35x35 mm',
                dimensions: { width: 35, height: 35, unit: 'mm' },
                background: ['White'],
                headSize: '70-80% of photo',
                requirements: [
                    'Recent color photo with white background',
                    'Head must cover 70-80% of the photo',
                    'Neutral expression with both eyes open',
                    'No shadows on face or background',
                    'No glasses (except for medical reasons)',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'CN': {
                name: 'China',
                flag: '🇨🇳',
                size: '33x48 mm',
                dimensions: { width: 33, height: 48, unit: 'mm' },
                background: ['White', 'Light blue'],
                headSize: '70-80% of photo',
                requirements: [
                    'Recent color photo taken within last 6 months',
                    'White or light blue background',
                    'Head must cover 70-80% of the photo',
                    'Neutral expression with mouth closed',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'CA': {
                name: 'Canada',
                flag: '🇨🇦',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White', 'Light gray'],
                headSize: '31-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'White or light gray plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 31-36 mm from chin to crown',
                    'No shadows on face or background',
                    'No glasses (unless medically necessary)'
                ]
            },
            'UK': {
                name: 'United Kingdom',
                flag: '🇬🇧',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['Cream', 'Light grey'],
                headSize: '29-34 mm from chin to crown',
                requirements: [
                    'Photo taken within last month',
                    'Cream or light grey plain background',
                    'Neutral expression with both eyes open and mouth closed',
                    'Head must measure 29-34 mm from chin to crown',
                    'No glasses with tinted lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'AU': {
                name: 'Australia',
                flag: '🇦🇺',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Recent photo taken within last 6 months',
                    'Plain white background with no shadows',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses (unless for medical reasons)',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'DE': {
                name: 'Germany',
                flag: '🇩🇪',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['Light grey'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'Light grey plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'JP': {
                name: 'Japan',
                flag: '🇯🇵',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White', 'Light grey'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'White or light grey plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'FR': {
                name: 'France',
                flag: '🇫🇷',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['Light grey'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'Light grey plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'BR': {
                name: 'Brazil',
                flag: '🇧🇷',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'White plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'RU': {
                name: 'Russia',
                flag: '🇷🇺',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White', 'Light grey'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'White or light grey plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'ZA': {
                name: 'South Africa',
                flag: '🇿🇦',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'White plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'SG': {
                name: 'Singapore',
                flag: '🇸🇬',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 3 months',
                    'White plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'AE': {
                name: 'UAE',
                flag: '🇦🇪',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White', 'Light blue'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'White or light blue plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            },
            'KR': {
                name: 'South Korea',
                flag: '🇰🇷',
                size: '35x45 mm',
                dimensions: { width: 35, height: 45, unit: 'mm' },
                background: ['White'],
                headSize: '32-36 mm from chin to crown',
                requirements: [
                    'Photo taken within last 6 months',
                    'White plain background',
                    'Neutral expression with both eyes open',
                    'Head must measure 32-36 mm from chin to crown',
                    'No glasses with dark lenses',
                    'No head coverings (except for religious purposes)'
                ]
            }
        };
        
        // Application state
        let currentStep = 1;
        let uploadedImage = null;
        let selectedCountry = null;
        let canvas = null;
        let ctx = null;
        let cropMode = false;
        let cropData = { x: 0, y: 0, width: 200, height: 200 };
        let originalImageData = null;
        let backgroundType = 'original';
        let backgroundColor = '#ffffff';
        let downloadType = 'single';
        let processedImageData = null;
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            setupEventListeners();
            populateCountries();
            setupCanvas();
        }
        
        function setupEventListeners() {
            // Upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            // Navigation
            document.getElementById('nextStep1').addEventListener('click', () => navigateToStep(2));
            document.getElementById('prevStep2').addEventListener('click', () => navigateToStep(1));
            document.getElementById('nextStep2').addEventListener('click', () => navigateToStep(3));
            document.getElementById('prevStep3').addEventListener('click', () => navigateToStep(2));
            document.getElementById('nextStep3').addEventListener('click', () => navigateToStep(4));
            document.getElementById('prevStep4').addEventListener('click', () => navigateToStep(3));
            document.getElementById('nextStep4').addEventListener('click', () => navigateToStep(5));
            document.getElementById('prevStep5').addEventListener('click', () => navigateToStep(4));
            
            // Editor controls
            document.getElementById('brightnessSlider').addEventListener('input', updateFilters);
            document.getElementById('contrastSlider').addEventListener('input', updateFilters);
            document.getElementById('saturationSlider').addEventListener('input', updateFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            document.getElementById('cropBtn').addEventListener('click', toggleCrop);
            
            // Background options
            document.querySelectorAll('.bg-option').forEach(option => {
                option.addEventListener('click', () => selectBackground(option.dataset.bg));
            });
            
            // Download options
            document.querySelectorAll('.download-option').forEach(option => {
                option.addEventListener('click', () => selectDownloadType(option.dataset.download));
            });
            
            document.getElementById('updateLayout').addEventListener('click', updatePreview);
            document.getElementById('downloadBtn').addEventListener('click', downloadImage);
        }
        
        function populateCountries() {
            const grid = document.getElementById('countryGrid');
            grid.innerHTML = '';
            
            Object.entries(countryData).forEach(([code, country]) => {
                const card = document.createElement('div');
                card.className = 'country-card';
                card.dataset.country = code;
                
                card.innerHTML = `
                    <div class="country-flag">${country.flag}</div>
                    <div class="country-info">
                        <h3>${country.name}</h3>
                        <div class="country-specs">${country.size}</div>
                    </div>
                `;
                
                card.addEventListener('click', () => selectCountry(code));
                grid.appendChild(card);
            });
        }
        
        function setupCanvas() {
            canvas = document.getElementById('editCanvas');
            ctx = canvas.getContext('2d');
        }
        
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showNotification('Please upload an image file', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showNotification('File size must be less than 10MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage = new Image();
                uploadedImage.onload = function() {
                    displayUploadedImage(e.target.result);
                    document.getElementById('nextStep1').disabled = false;
                    showNotification('Photo uploaded successfully!');
                };
                uploadedImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function displayUploadedImage(src) {
            const preview = document.getElementById('uploadedPreview');
            const img = document.getElementById('uploadedImage');
            img.src = src;
            preview.style.display = 'block';
        }
        
        function selectCountry(countryCode) {
            // Update UI
            document.querySelectorAll('.country-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-country="${countryCode}"]`).classList.add('selected');
            
            selectedCountry = countryCode;
            const country = countryData[countryCode];
            
            // Show requirements
            const panel = document.getElementById('requirementsPanel');
            const list = document.getElementById('requirementsList');
            list.innerHTML = '';
            
            country.requirements.forEach(req => {
                const item = document.createElement('li');
                item.className = 'req-item';
                item.innerHTML = `
                    <i class="fas fa-check-circle req-icon"></i>
                    <span>${req}</span>
                `;
                list.appendChild(item);
            });
            
            panel.classList.add('show');
            document.getElementById('nextStep2').disabled = false;
            
            showNotification(`Selected ${country.name} requirements`);
        }
        
        function navigateToStep(step) {
            // Update step indicators
            for (let i = 1; i <= 5; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const content = document.getElementById(`step${i}`);
                
                if (i < step) {
                    indicator.classList.add('completed');
                    indicator.classList.remove('active');
                } else if (i === step) {
                    indicator.classList.add('active');
                    indicator.classList.remove('completed');
                } else {
                    indicator.classList.remove('active', 'completed');
                }
                
                content.classList.toggle('active', i === step);
            }
            
            currentStep = step;
            
            // Initialize step-specific content
            if (step === 3) {
                initializeEditor();
            } else if (step === 4) {
                initializeBackground();
            } else if (step === 5) {
                initializeDownload();
            }
        }
        
        function initializeEditor() {
            if (!uploadedImage || !selectedCountry) return;
            
            const country = countryData[selectedCountry];
            const aspectRatio = country.dimensions.width / country.dimensions.height;
            
            // Set canvas size
            const maxWidth = 500;
            const maxHeight = 600;
            
            let canvasWidth, canvasHeight;
            if (maxWidth / maxHeight > aspectRatio) {
                canvasHeight = maxHeight;
                canvasWidth = canvasHeight * aspectRatio;
            } else {
                canvasWidth = maxWidth;
                canvasHeight = canvasWidth / aspectRatio;
            }
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Draw image
            ctx.drawImage(uploadedImage, 0, 0, canvasWidth, canvasHeight);
            originalImageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
            
            // Set initial crop area
            cropData = {
                x: canvasWidth * 0.1,
                y: canvasHeight * 0.1,
                width: canvasWidth * 0.8,
                height: canvasHeight * 0.8
            };
            
            updateCropOverlay();
            updateHeadGuide();
        }
        
        function updateFilters() {
            if (!originalImageData) return;
            
            const brightness = parseInt(document.getElementById('brightnessSlider').value);
            const contrast = parseInt(document.getElementById('contrastSlider').value);
            const saturation = parseInt(document.getElementById('saturationSlider').value);
            
            document.getElementById('brightnessValue').textContent = brightness;
            document.getElementById('contrastValue').textContent = contrast;
            document.getElementById('saturationValue').textContent = saturation;
            
            // Apply filters
            ctx.putImageData(originalImageData, 0, 0);
            ctx.filter = `brightness(${100 + brightness}%) contrast(${100 + contrast}%) saturate(${100 + saturation}%)`;
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
        }
        
        function resetFilters() {
            document.getElementById('brightnessSlider').value = 0;
            document.getElementById('contrastSlider').value = 0;
            document.getElementById('saturationSlider').value = 0;
            updateFilters();
        }
        
        function toggleCrop() {
            cropMode = !cropMode;
            const overlay = document.getElementById('cropOverlay');
            const btn = document.getElementById('cropBtn');
            
            overlay.style.display = cropMode ? 'block' : 'none';
            btn.innerHTML = cropMode ? 
                '<i class="fas fa-check"></i> Apply Crop' : 
                '<i class="fas fa-crop"></i> Enable Crop';
            
            if (cropMode) {
                updateCropOverlay();
            }
        }
        
        function updateCropOverlay() {
            const overlay = document.getElementById('cropOverlay');
            overlay.style.left = cropData.x + 'px';
            overlay.style.top = cropData.y + 'px';
            overlay.style.width = cropData.width + 'px';
            overlay.style.height = cropData.height + 'px';
        }
        
        function updateHeadGuide() {
            const guide = document.getElementById('headGuide');
            const headHeight = cropData.height * 0.7;
            const headY = cropData.y + cropData.height * 0.15;
            
            guide.style.left = cropData.x + 'px';
            guide.style.top = headY + 'px';
            guide.style.width = cropData.width + 'px';
            guide.style.height = headHeight + 'px';
        }
        
        function initializeBackground() {
            // Reset background options
            document.querySelectorAll('.bg-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('[data-bg="original"]').classList.add('selected');
            
            // Populate color options
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = '';
            
            if (selectedCountry) {
                const country = countryData[selectedCountry];
                const colorMap = {
                    'White': '#ffffff',
                    'Off-white': '#f8f8f8',
                    'Light blue': '#e6f3ff',
                    'Light grey': '#e0e0e0',
                    'Cream': '#f5f5dc'
                };
                
                country.background.forEach(bgColor => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = colorMap[bgColor] || '#ffffff';
                    swatch.dataset.color = colorMap[bgColor] || '#ffffff';
                    
                    swatch.addEventListener('click', () => {
                        document.querySelectorAll('.color-swatch').forEach(s => {
                            s.classList.remove('selected');
                        });
                        swatch.classList.add('selected');
                        backgroundColor = swatch.dataset.color;
                    });
                    
                    palette.appendChild(swatch);
                });
            }
        }
        
        function selectBackground(type) {
            backgroundType = type;
            
            document.querySelectorAll('.bg-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-bg="${type}"]`).classList.add('selected');
            
            const palette = document.getElementById('colorPalette');
            palette.style.display = type === 'color' ? 'flex' : 'none';
        }
        
        function initializeDownload() {
            // Process the image with background changes
            processImageWithBackground().then(() => {
                updatePreview();
            });
        }
        
        function processImageWithBackground() {
            return new Promise((resolve) => {
                if (!canvas || !selectedCountry) {
                    resolve();
                    return;
                }
                
                showProcessing(true);
                
                // Create a temporary canvas for processing
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Set the canvas size to match the country's dimensions
                const country = countryData[selectedCountry];
                const aspectRatio = country.dimensions.width / country.dimensions.height;
                
                // Set a reasonable size for processing (300 DPI)
                const mmToInch = 0.0393701;
                const dpi = 300;
                const widthInPixels = Math.round(country.dimensions.width * mmToInch * dpi);
                const heightInPixels = Math.round(country.dimensions.height * mmToInch * dpi);
                
                tempCanvas.width = widthInPixels;
                tempCanvas.height = heightInPixels;
                
                // Get the current image from the editor canvas
                const sourceCanvas = canvas;
                const sourceCtx = ctx;
                
                // Draw the image with the selected background
                if (backgroundType === 'original') {
                    // Just use the original image
                    tempCtx.drawImage(sourceCanvas, 0, 0, widthInPixels, heightInPixels);
                } else if (backgroundType === 'color') {
                    // Fill with the selected background color
                    tempCtx.fillStyle = backgroundColor;
                    tempCtx.fillRect(0, 0, widthInPixels, heightInPixels);
                    
                    // Draw the image on top
                    tempCtx.drawImage(sourceCanvas, 0, 0, widthInPixels, heightInPixels);
                } else if (backgroundType === 'remove') {
                    // For background removal, we'll simulate it by creating a transparent background
                    // In a real implementation, you would use a proper background removal algorithm
                    tempCtx.clearRect(0, 0, widthInPixels, heightInPixels);
                    
                    // Draw the image
                    tempCtx.drawImage(sourceCanvas, 0, 0, widthInPixels, heightInPixels);
                    
                    // Simulate background removal by making the background transparent
                    // This is a simplified approach - in reality, you'd use a proper segmentation algorithm
                    const imageData = tempCtx.getImageData(0, 0, widthInPixels, heightInPixels);
                    const data = imageData.data;
                    
                    // Simple threshold-based background removal (very basic simulation)
                    // In a real app, you would use a proper AI-based background removal
                    for (let i = 0; i < data.length; i += 4) {
                        // Simple check for light-colored pixels (simulating background)
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // If the pixel is light-colored, make it transparent
                        if (r > 200 && g > 200 && b > 200) {
                            data[i + 3] = 0; // Set alpha to 0 (transparent)
                        }
                    }
                    
                    tempCtx.putImageData(imageData, 0, 0);
                }
                
                // Store the processed image data
                processedImageData = tempCanvas.toDataURL('image/png');
                
                // Hide processing overlay
                setTimeout(() => {
                    showProcessing(false);
                    resolve();
                }, 1000);
            });
        }
        
        function selectDownloadType(type) {
            downloadType = type;
            
            document.querySelectorAll('.download-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-download="${type}"]`).classList.add('selected');
            
            const customLayout = document.getElementById('customLayout');
            customLayout.classList.toggle('show', type === 'custom');
            
            updatePreview();
        }
        
        function updatePreview() {
            const previewCanvas = document.getElementById('previewCanvas');
            const previewCtx = previewCanvas.getContext('2d');
            
            // Set canvas size based on download type
            if (downloadType === 'single') {
                previewCanvas.width = 400;
                previewCanvas.height = 500;
            } else if (downloadType === 'a4') {
                previewCanvas.width = 595; // A4 width in pixels at 72 DPI
                previewCanvas.height = 842; // A4 height in pixels at 72 DPI
            } else if (downloadType === 'halfa4') {
                previewCanvas.width = 595;
                previewCanvas.height = 421;
            } else {
                previewCanvas.width = 595;
                previewCanvas.height = 842;
            }
            
            // Clear canvas
            previewCtx.fillStyle = '#ffffff';
            previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
            
            // Get photo dimensions
            if (selectedCountry && processedImageData) {
                const country = countryData[selectedCountry];
                const aspectRatio = country.dimensions.width / country.dimensions.height;
                
                // Load the processed image
                const img = new Image();
                img.onload = function() {
                    let photoWidth, photoHeight;
                    if (downloadType === 'single') {
                        photoWidth = 300;
                        photoHeight = photoWidth / aspectRatio;
                        
                        // Draw single photo
                        const x = (previewCanvas.width - photoWidth) / 2;
                        const y = (previewCanvas.height - photoHeight) / 2;
                        
                        previewCtx.drawImage(img, x, y, photoWidth, photoHeight);
                        
                        // Add border if background is removed
                        if (backgroundType === 'remove') {
                            previewCtx.strokeStyle = '#e2e8f0';
                            previewCtx.lineWidth = 1;
                            previewCtx.strokeRect(x, y, photoWidth, photoHeight);
                        }
                        
                        // Add text
                        previewCtx.fillStyle = '#64748b';
                        previewCtx.font = '16px Inter';
                        previewCtx.textAlign = 'center';
                        previewCtx.fillText(`${country.name} Passport Photo`, previewCanvas.width / 2, 40);
                        previewCtx.fillText(`${country.size}`, previewCanvas.width / 2, 65);
                    } else {
                        // Calculate for sheet layout
                        let rows, cols;
                        if (downloadType === 'a4') {
                            rows = 2;
                            cols = 4;
                        } else if (downloadType === 'halfa4') {
                            rows = 2;
                            cols = 2;
                        } else {
                            rows = parseInt(document.getElementById('layoutRows').value);
                            cols = parseInt(document.getElementById('layoutCols').value);
                        }
                        
                        const margin = 20;
                        const spacing = 10;
                        photoWidth = (previewCanvas.width - 2 * margin - (cols - 1) * spacing) / cols;
                        photoHeight = photoWidth / aspectRatio;
                        
                        // Draw multiple photos
                        for (let row = 0; row < rows; row++) {
                            for (let col = 0; col < cols; col++) {
                                const x = margin + col * (photoWidth + spacing);
                                const y = margin + row * (photoHeight + spacing);
                                
                                // Draw photo
                                previewCtx.drawImage(img, x, y, photoWidth, photoHeight);
                                
                                // Add border if background is removed
                                if (backgroundType === 'remove') {
                                    previewCtx.strokeStyle = '#e2e8f0';
                                    previewCtx.lineWidth = 1;
                                    previewCtx.strokeRect(x, y, photoWidth, photoHeight);
                                }
                            }
                        }
                        
                        // Add text
                        previewCtx.fillStyle = '#64748b';
                        previewCtx.font = '14px Inter';
                        previewCtx.textAlign = 'center';
                        previewCtx.fillText(`${country.name} Passport Photos`, previewCanvas.width / 2, 20);
                    }
                };
                img.src = processedImageData;
            }
        }
        
        function downloadImage() {
            if (!processedImageData) {
                showNotification('Please process your image first', 'error');
                return;
            }
            
            const previewCanvas = document.getElementById('previewCanvas');
            const link = document.createElement('a');
            
            let filename = 'passport-photo';
            if (selectedCountry) {
                const country = countryData[selectedCountry];
                filename = `${country.name.toLowerCase().replace(' ', '-')}-passport-photo`;
            }
            
            filename += `-${downloadType}.png`;
            link.download = filename;
            link.href = previewCanvas.toDataURL('image/png');
            link.click();
            
            showNotification('Photo downloaded successfully!');
        }
        
        function showProcessing(show) {
            const overlay = document.getElementById('processingOverlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('.notification-icon');
            const text = notification.querySelector('.notification-text');
            
            text.textContent = message;
            notification.className = `notification ${type} show`;
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle notification-icon';
            } else {
                icon.className = 'fas fa-exclamation-circle notification-icon';
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
